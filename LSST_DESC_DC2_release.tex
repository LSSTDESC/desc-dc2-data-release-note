% ====================================================================
%
% LSST DESC DC2 Data Release Note
%
% ====================================================================

\documentclass[11pt]{report}

\include{inc/doc_settings} % formatting for doc, copied from SRM

\include{inc/macros}       % commands and abbreviations, adapted from SRM doc_macros.tex

% ====================================================================
\usepackage{float,longtable,threeparttablex,booktabs}

\begin{document}
\pagenumbering{gobble}

%%%%% TITLE PAGE
\pagestyle{empty}

\vspace*{0.2\textheight}

\begin{center}
{\Huge\bfseries The LSST Dark Energy Science Collaboration (DESC)\\
\bigskip DC2 Data Release Note}

\vspace*{0.2\textheight}

\input{commitID.tex}

\vspace*{0.1\textheight}

\begin{figure}[!h]
\centering\includegraphics[width=5cm,angle=0]{inc/desc-logo.png}
\end{figure}

\end{center}

% %%%%% VERSION HISTORY
\clearpage
\include{inc/version}

\clearpage

\phantomsection\section*{Contributors}
% Force the Contributor listing to show up in the TOC even though it's a section*:
\addcontentsline{toc}{section}{Contributors}

\input{inc/contributions.tex}


% %%%%% TABLE OF CONTENTS
\clearpage
{\let\cleardoublepage\clearpage}

\vspace*{-1.0in}
\maketoc
\label{toc}

\clearpage

%%%%%%%% FOOTER
\pagestyle{fancy}
\fancyfoot{} % clear all footer fields
\fancyfoot[R]{\thepage}  % page number in "outer" position of footer line
% \fancyfoot[L]{\footernavigationbar}  % navigation to contents etc

%%%%%%%% HEADER
\fancyhead[L]{}
\fancyhead[R]{LSST DESC DC2 Data Release}
\renewcommand{\footrulewidth}{1pt}

\setlength\parindent{0em}
\setlength{\parskip}{0.5em}
% ====================================================================

% % FRONT MATTER
% \renewcommand{\thepage}{\roman{page}}% Roman numerals for page counter
% \setcounter{page}{0}

% ====================================================================

\renewcommand{\thepage}{\arabic{page}}
\setcounter{page}{1}

\renewcommand\thefigure{\arabic{figure}}
\setcounter{figure}{0}

% ====================================================================

\phantomsection\section*{Executive Summary and Quick Start Guide}
% Force the Executive Summary to show up in the TOC even though it's a section*:
\addcontentsline{toc}{section}{Executive Summary and Quick Start Guide}




\section{Introduction}

\note{\bf UNDER CONSTRUCTION!}

\begin{itemize}
\item Description of the purpose of the LSST DESC data challenges, including DC1 and DC2:
\item Very brief overview of the generation
\item Some example use cases
\end{itemize}

In the next decade the Vera C. Rubin Observatory will carry out an unprecedented survey of the sky, the Legacy Survey of Space and Time \citep{2009arXiv0912.0201L}. One of the major aims of the survey is to unravel the origin of the cause for the accelerated expansion of the Universe. The LSST Dark Energy Science Collaboration (DESC) was formed to carry out this exciting endeavor~\citep{Abate:2012za}. In order to prepare for the arrival of data, LSST DESC has prepared two data challenges, DC1 and DC2, based on sophisticated image simulations. The data challenges have been design to mimic actual data from the Rubin Observatory as closely as possible. 

GENERAL DESCRIPTION OF THE DATA CHALLENGES: Both data challenges are based on realistic simulations of the extragalactic sky, imSim, LSST Science Pipelines~\citep{2017ASPC..512..279J} TBC. The first data challenge, DC1, covers a $\sim$40 deg$^2$ area and ten years of observations. The image simulations were carried out for $r$-band only. A detailed description and a range of analysis results are provided in~\cite{dc1}. 

In this data release note, we focus on the second data challenge, DC2. A comprehensive description of the LSST DESC DC2 Simulated Sky Survey can be found in~\cite{2020arXiv201005926L}. For completeness, we provide a brief description here. MORE TEXT HERE. The underlying extragalactic catalog, cosmoDC2, is described in~\cite{korytov} and is publicly available\footnote{\https{portal.nersc.gov/project/lsst/cosmoDC2/}}.


This note is organized as follows. In~\autoref{sec:features} we describe the major features of the DC2 dataset.
We provide an overview of the data products that are part of this release in Section~\autoref{sec:products}.
We provide instructions for how to access the data in~\autoref{sec:access}.
Together with the data itself, we release a set of selected notebooks that contain examples for common data analysis tasks.
The notebooks are introduced in~\autoref{sec:notebooks}.
%In Section~\autoref{sec:validation} we present our validation and characterization of the DC2 data products.
We conclude in~\autoref{sec:outlook} and provide a brief description of possible future data releases. 

\section{Major Features of the Dataset}
\label{sec:features}
\note{\bf UNDER CONSTRUCTION!}

\subsection{Astrophysical Inputs}

The astrophysical components of this dataset are mostly limited to the types of objects needed to support static probes of dark energy science, specifically the galaxies from the cosmoDC2 extragalactic catalog.  This dataset does include stars from a simulated Milky Way, which are needed for the astrometric and photometric calibration by the image processing pipeline, as well as type Ia supernovae, which were included throughout the 300~deg$^2$ DC2 region.

As noted, the galaxies are from the cosmoDC2 extragalactic catalog, which covers 440 deg$^2$ out to a redshift of $z = 3$ and are complete to $m_r <28$.  The cosmoDC2 catalog is based on the Outer Rim N-body simulation, and the properties of the galaxies were derived using the Galacticus semi-analyitic model.  These properties include stellar mass, morphology, spectral energy distributions, broadband filter magnitudes, host halo information, and weak lensing shear.  All galaxies have separate bulge and disk components that are rendered as sersic profiles, and galaxies with $m_i > 27$ have ``knots'' of star-formation added in order to model more complex light profiles for fainter galaxies. The fluxes for these star forming regions have been re-allocated from the disk component and the knots have the same SED as the disk.

The Milky Way stars are simulated using the Galfast model of Juric et al (2008), which is based on densities and colors of sources in SDSS. Stellar variability is included for periodic objects (e.g., RR Lyrae and Cepheids) and for non-periodic variables (e.g., CVs, flaring M-dwarfs, etc.).  Stars without a definitive variability class are modeled based on the Kepler Q17 data release.  The Galactic reddening is based on the three-dimensional model of Amores and Lepine (2005).

Finally, type Ia supernovae have been added throughout the DC2 region out to a redshift of $z=1.4$ with a population density that is consistent with observations.

\subsection{Image Simulation Features}

DC2 used the minion\_1016 observing cadence (ref) which was Rubin Observatory the baseline cadence at start of the DC2 simulations. This cadence provides provides the nominal field positions, telescope rotations, and filter selections for each pointing, as well as predicted seeing, airmass, and sky background components.  We have added random translational and rotational dithering to the nominal pointings in order to make the sky coverage more uniform.

The imSim simulation software uses the GalSim package (ref) to render the astrophysical objects and the night sky.  The PSFs for each exposure are computed using a set of atmospheric phase screens that are realizations of Gaussian random fields with a Von Karman power spectrum.  In addition, the PSF calculation includes an optical model of the telescope based on modeling of the active optics system for the Rubin Observatory.  After convolution with the PSF, objects are rendered using GalSim's sensor model which includes the brighter-fatter and tree-ring electrostatic effects that are seen in the types of CCDs used in LSSTCam.  Finally, electronics readout effects such as bleed trails, CCD segmentation, intra-CCD cross-talk, read noise, etc., are included. These effects are based on measurements of the actual LSSTCam hardware.


\section{Data Products}
\label{sec:products}

This Release (v1) includes two major data sets: the ``Object Table'' and the ``Truth-match Table.'' 

\subsection{Object Table}
\label{sec:object}

The Object Table contains information about static astronomical objects measured on a stacked (coadd) image. The photometry in the Object Table is measured with the forced photometry method, i.e., it is consistently measured across multiple bands using a fixed position, which is determined from the reference filter for each source (the filter that best measures the source). 

The generation of the Object Table is described in detail in \S~8 of \cite{2020arXiv201005926L}. In short, after the LSST Science Pipeline produces the deepCoadd catalogs of multiple bands, we merge these catalogs across bands, and apply certain column renaming and translations to produce the final Object Table. The renaming and translations are meant to produce a science-ready catalog that resembles LSE-163 for the end users. 

\subsubsection{Available Data Sets}

Object Tables that have been released publicly are listed below.

\begin{itemize}
  \item Run 2.2i DR6 (Year 1--5) WFD Object Table
\end{itemize}

\subsubsection{Object Table Schema}

\input{inc/schema_object}

\subsection{Truth-match Table}
\label{sec:truth}

The Truth Table records the measurable fluxes of astronomical objects that are served as input values to the image simulations. Several types of astronomical objects are included in the image simulations: galaxies, stars, supernovae (SNe), active galactic nucleus (AGN) components, and multiply imaged quasars (QSOs). 

In the Truth-match Table, we also store basic matching information with respect to the Object Table. The matching procedure is described in \S\,4.2.1 of \cite{2020arXiv201005926L}. 
Specifically, for each entry in the Object Table:
\begin{enumerate}
    \item Search for all truth entries that are within 1~arcsec and have a $r$-band magnitude difference ($\Delta r$) less than 1~mag. If one or more truth entries that satisfy these criteria are found, pick the truth entry that has the smallest $\Delta r$ as the match, and set \code{is_good_match} to True.
    \item If no truth entry was found in Step (1), pick the truth entry that is the nearest neighbor of the object entry on sky as the match, and set \code{is_good_match} to False.
\end{enumerate}
Given this procedure, every entry in the Object Table will be assigned exactly one match. The majority of object entries will have a ``good'' match (i.e., satisfying criteria in Step 1 above), and the rest would have a nearest-neighbor match. Note that more than 90\% of the ``good'' matches would also happen to be the nearest neighbor match. 

Because the Object Table was used as the reference catalog for the matching procedure, some truth entries may be chosen as a match more than once, while others may not be chosen as a match at all. To both preserve all truth information and facilitate comparison with the Object Table, the Truth-match Table is ordered in a specific fashion. For each file of the Truth-match Table,
\begin{itemize}
    \item The first $N$ rows have exactly the same row order as the  Object Table of the corresponding part of the sky, where $N$ is the number of Object Table entries.
    \item The remaining $M$ rows are truth entries that were not chosen as a match; they all have \code{match_objectId == -1}.
    \item Since some truth entries may appear more than once in the first $N$ rows, a boolean mask \code{is_unique_truth_entry} can be used to select unique truth entries. 
\end{itemize}
These structures are particularly important for users who wish to access the files directly. For users who use GCRCatalogs (\autoref{sec:gcr}), the reader will automatically select the correct rows depending on whether you are loading the Truth Table or the Match Table (see \autoref{sec:notebooks} for examples).


\subsubsection{Available Data Sets}

Truth-match tables that have been released publicly are listed below.

\begin{itemize}
  \item Run 2.2i Truth Summary Table, with matching information to the DR6 WFD Object Table
\end{itemize}

\subsubsection{Truth-match Table Schema}

\input{inc/schema_truth}



\section{Data Access}
\label{sec:access}

All data products in this release are stored in the Apache Parquet\footnote{\https{parquet.apache.org}} format, an efficient columnar storage form, with I/O tools readily available in multiple development systems. 
The data files can be easily downloaded to the user's machine via Globus Online (\autoref{sec:download}). 
We further provide a Python package, \code{GCRCatalogs}, which contains a high-level user API to access the data (\autoref{sec:gcr}). 

Each data set is partitioned into several files that correspond to different parts of the sky. The partition is based on the ``tract'' value in the ``Rings sky map'' pixelization of LSST Pipeline.\footnote{\https{pipelines.lsst.io/py-api/lsst.skymap.ringsSkyMap.RingsSkyMap.html}} \autoref{fig:skymap} shows a visual representation of the partition. 

\begin{figure}[tbh!]
    \centering
    \includegraphics[width=0.8\textwidth]{figs/skymap.png}
    \caption{Sky Map}
    \label{fig:skymap}
\end{figure}



\subsection{Obtaining Data Files via Globus Online}
\label{sec:download}

\subsection{Accessing Data Files via GCRCatalogs}
\label{sec:gcr}



\section{Example Notebooks}
\label{sec:notebooks}

\section{Validation and Characterization}
\label{sec:validation}

\note{MWV: I started this section, but maybe all of this stuff should go in a different paper.  We presented a few things in the DC2 Paper, and we're not going to be exhaustive here.  But I'm in favor of putting something that characterizes the data products in a Note describing the data products.
We also might want to highlight known things that might otherwise trigger immediate questions.  E.g., the discreteness of the M-type stellar models.}

\note{YYM: Some of this characterization should go into Sec 2 ``Major Features''}

\note{MWV: Maybe another more minimally disruptive direction to go would be to include a rendered copy of the Object Table Validation notebook, \code{validate_dc2_run2.2i_object_table.ipynb}, under the Example Notebooks or as an appendix.  Can add the tests Plaszczynski has been doing to this Notebook to help complete things.}

\subsection{Tests of the Object Table}

These tests can be asked of any coadd catalog from real or simulated data.

\begin{itemize}
  \item Do we cover the RA and Dec as expected
  \item Are stars point-like and galaxies extended?
  \item Is the distribution of measured PSFs reasonable.  Note that this is on the coadds for the current level of processing, but the coadds should be representative of the distribution of PSFs from the input images.
  \item Does a color-color diagram of stars look reasonable?
  \item Are the image 5-sigma point-source depths reasonable?
  \item Is the areal density of galaxies on the sky reasonable?
      \begin{itemize}
          \item Check both versus other surveys using real data of the real sky. 
      \end{itemize}
  \item Is the number density of galaxies vs. brightness (say i band magnitude) reasonable?
      \begin{itemize}
          \item Check both versus other surveys using real data of the real sky. 
      \end{itemize}
  \item Is the separation of stars vs. galaxies decent.  Does it behave as expected as a function of SNR?  Are there unexpected features?
  \item Is the distribution of shape, ellipticity, and T second moments reasonable and as expected?
  \item Is the distribution of [shear-based] e1, e2, $e_\text{abs}$ reasonable?  Are there patterns in the distribution across the sky?
  \item What's the relationship between different types of extended-object photometry?
  \item Do Central Cluster galaxies follow the red sequence?
  \begin{itemize}
      \item Is the cluster red sequence visible in z vs. g-r and r-z vs. g-r plots of extended objects in the data?
      \item If you run a cluster finder, and then identify central galaxies, do you find that the expected central cluster galaxy red sequence pops out clearly?
  \end{itemize}

\end{itemize}

\subsection{Comparison of the Object Table with Truth}

Comparison against the known characteristics of the models without matching:

\begin{itemize}
  \item Does the areal density of stars match the input model of the Milky Way?
  \item Does the number density of galaxies vs. brightness (say i band magnitude) match the input model?
\end{itemize}

The following questions can only be asked after matching the observered catalog to the truth catalogs.

\begin{itemize}
  \item Observed - Truth magnitude
  \begin{itemize}
      \item For stars, galaxies.  Point source and extended model photometry.
      \item Is the distribution centered at 0?
      \item Is it symmetric or skewed?
      \item Is the skew consistent with (reverse) Malmquist bias at bright end?
      \item As a function of brightness.
        \item Does the scatter at the low SNR end follow the reported uncertainties?
        \item What happens at the bright end? Are the effects of saturation visible?
      \item Is a constant offset?  If so, is it consistent with a bookkeeping error somewhere?
      \item What's the behavior for a SNR > 10 cut.
  \end{itemize}

  \item Galaxies
  \begin{itemize}
      \item Do Central Cluster galaxies follow the red sequence?
        \item Look in r-z vs g-r
        \item This can be done using the truth catalog identify cluster members.  And the presented matched plots
        \item Compare truth 
        \item data vs. redshift
        \item Compare truth -data vs. g-r color.
        \item This analysis complements the data-only analysis above.
    \end{itemize}
\end{itemize}

\section{Conclusion and Outlook}
\label{sec:outlook}


\clearpage

\phantomsection\section*{Acknowledgments}
\addcontentsline{toc}{section}{Acknowledgements}

\input{desc-tex/ack/standard.tex}

% Individual acknowledgments (sorted by author order)
The work of APH, KH, EK, PL, and ASV at Argonne National Laboratory was supported under the U.S. DOE contract DE-AC02-06CH11357.
Support for YYM was provided by NASA through the NASA Hubble Fellowship grant no.\ HST-HF2-51441.001 awarded by the Space Telescope Science Institute, which is operated by the Association of Universities for Research in Astronomy, Incorporated, under NASA contract NAS5-26555. 



% %%%%%%%% END MATTER
\clearpage


\bibliographystyle{inc/apj-mod}
\phantomsection\bibliography{ref}


\clearpage
\appendix
\renewcommand\thefigure{\thesection\arabic{figure}}
\renewcommand\thetable{\thesection\arabic{table}}
\renewcommand{\thesection}{\Alph{section}}
\renewcommand{\thesubsection}{\Alph{section}\arabic{subsection}}

\phantomsection\section*{Appendices}
\addcontentsline{toc}{section}{Appendices}





\end{document}

% ====================================================================
